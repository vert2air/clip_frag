// ============================================================================
// src/app/encoding.rs
// ============================================================================
//
// このファイルでは、入力データのエンコードを判定し、UTF-8 の String に
// デコードするための関数を提供する。
// 
// clip_frag が扱う入力データは、以下の 2 種類を想定している：
//
//   - UTF-8
//   - Shift_JIS
//
// まず UTF-8 として解釈を試み、失敗した場合は Shift_JIS とみなす。
// Shift_JIS としてもデコードできなければエラーとする。
// 
// この処理は、ファイル入力・標準入力のどちらにも共通して使われる。
// ============================================================================

use anyhow::Result;
use encoding_rs::SHIFT_JIS;

// -----------------------------------------------------------------------------
// detect_encoding_and_decode
// -----------------------------------------------------------------------------
//
// バイト列からエンコードを判定し、UTF-8 の String にデコードする。
// 
// 戻り値：
//   (decoded_string, "UTF-8") または (decoded_string, "Shift_JIS")
//
// エラー：
//   UTF-8 としても Shift_JIS としても解釈できない場合。
// -----------------------------------------------------------------------------
pub fn detect_encoding_and_decode(buf: &[u8]) -> Result<(String, &'static str)> {
    // ------------------------------------------------------------
    // 1. UTF-8 として解釈を試みる
    // ------------------------------------------------------------
    if let Ok(s) = String::from_utf8(buf.to_vec()) {
        return Ok((s, "UTF-8"));
    }

    // ------------------------------------------------------------
    // 2. UTF-8 でなければ Shift_JIS とみなしてデコードする
    // ------------------------------------------------------------
    let (cow, _, had_errors) = SHIFT_JIS.decode(buf);

    if had_errors {
        // Shift_JIS としてもデコードに失敗した場合はエラー
        anyhow::bail!(
            "入力データのエンコード判定に失敗しました（UTF-8 / Shift_JIS いずれでも解釈できません）"
        );
    }

    Ok((cow.to_string(), "Shift_JIS"))
}
