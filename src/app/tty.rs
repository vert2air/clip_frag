// ============================================================================
// src/app/tty.rs
// ============================================================================
//
// このファイルでは、OS ごとに異なる「TTY（端末）からの入力」を安全に扱うための
// 関数 read_line_from_tty() を提供する。
// 
// clip_frag のような CLI では、標準入力がパイプで埋まっているケースが多い。
// そのため、ユーザのキー入力を受け取るには、stdin ではなく TTY を直接開く必要がある。
// 
//   - Unix 系 OS: /dev/tty を開く
//   - Windows:    CONIN$ を開く
//
// これにより、以下のようなケースでも正しく動作する：
//
//   cat huge.txt | clip_frag
//
// 標準入力は huge.txt の内容で埋まっているが、ユーザの操作は TTY から受け取れる。
// ============================================================================

use anyhow::Result;
use std::io::{self, BufRead, BufReader};
use std::fs::File;

// -----------------------------------------------------------------------------
// read_line_from_tty
// -----------------------------------------------------------------------------
//
// OS ごとに適切な TTY デバイスを開き、1 行読み込んで返す。
// 
// 戻り値：
//   Ok(String) — 改行を含む 1 行（trim() は呼び出し側で行う）
// 
// エラー：
//   TTY が開けない場合、読み込みに失敗した場合など。
// -----------------------------------------------------------------------------
pub fn read_line_from_tty() -> Result<String> {
    #[cfg(unix)]
    {
        // ------------------------------------------------------------
        // Unix 系 OS の場合
        // ------------------------------------------------------------
        //
        // /dev/tty は「現在の端末」を表す特殊ファイルで、
        // 標準入力がパイプで埋まっていても、ユーザのキー入力を受け取れる。
        //
        let file = File::open("/dev/tty")?;
        let mut reader = BufReader::new(file);

        let mut buf = String::new();
        reader.read_line(&mut buf)?;
        Ok(buf)
    }

    #[cfg(windows)]
    {
        // ------------------------------------------------------------
        // Windows の場合
        // ------------------------------------------------------------
        //
        // Windows では /dev/tty の代わりに "CONIN$" を使う。
        // これは「コンソール入力デバイス」を表す特殊ファイルで、
        // 標準入力がパイプで埋まっていても、ユーザのキー入力を受け取れる。
        //
        let file = File::open("CONIN$")?;
        let mut reader = BufReader::new(file);

        let mut buf = String::new();
        reader.read_line(&mut buf)?;
        Ok(buf)
    }
}
